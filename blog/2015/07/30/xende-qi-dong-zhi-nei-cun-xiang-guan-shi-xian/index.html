
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Xen的启动之内存相关实现 - Mctrain's Blog</title>
  <meta name="author" content="Liu Yutao">

  
  <meta name="description" content="blog to record the technique diary, life feeling and whatever I'v learned that is valuable.">
  <meta name="keywords" content="Xen Memory">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ytliu.github.io/blog/2015/07/30/xende-qi-dong-zhi-nei-cun-xiang-guan-shi-xian">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/atom.xml" rel="alternate" title="Mctrain's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="./javascripts/libs/jquery.min.js"></script>
  <!--<script src="http://ajax.useso.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
  <!--  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>-->
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts 
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Delius' rel='stylesheet' type='text/css'>
-->
<link href="http://fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


  

</head>

<body    style="margin:auto">
  <header role="banner"><hgroup>
  <h1><a href="/">Mctrain's Blog</a></h1>
  
    <h2>What I learned in IT, as well as thought about life</h2>
  
</hgroup>


</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="mctrain016@gmail.com" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ytliu.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/paper">Papers</a></li>
  <li><a href="/notes">Notes</a></li>
  <li><a href="/life">Life</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Xen的启动之内存相关实现</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-30T21:36:00+08:00" pubdate data-updated="true">Jul 30<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://ytliu.info/blog/2015/07/28/xende-nei-cun-bu-ju/">上篇博客</a>介绍了Xen的整体内存分布情况，这篇博文主要从Xen的启动入手，介绍Xen在启动的时候是如何初始化它的内存，包括如何分配内存区域，如何初始化页表，以及如何在不同阶段初始化不同的内存分配器等等。</p>

<!-- more -->


<p>这篇博文借鉴了一些<a href="http://bbs.chinacloud.cn/attachment.aspx?attachmentid=397">这篇文章</a>的内容，不过主要介绍的是最新版本的Xen在64位机器下的内存相关实现。</p>

<p>好，现在开始进入正题！</p>

<h3>Xen的启动</h3>

<p>在介绍Xen启动的内存实现之前，先大致介绍下Xen的启动的整个流程（参考<a href="http://bbs.chinacloud.cn/attachment.aspx?attachmentid=397">这里</a>)：</p>

<h4>汇编部分：</h4>

<p>汇编部分代码都在<code>xen-source/xen/arch/x86/boot/</code>目录下</p>

<p><code>head.S</code>，这个是整个Xen的入口：<code>ENTRY(start)</code>：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">ENTRY</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</span><span class='line'>        <span class="n">jmp</span>     <span class="n">__start</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>里面主要做了下面几件事：</p>

<ul>
<li>装入GDT (trampoline_gdt)：</li>
</ul>


<table>
<thead>
<tr>
<th align="left">GDT项 </th>
<th align="left"> 说明 </th>
<th align="left"> 段选择子</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">1 </td>
<td align="left"> ring0 code, 32-bit mode </td>
<td align="left"> BOOT_CS32 (0x0008)</td>
</tr>
<tr>
<td align="left">2 </td>
<td align="left"> ring0 code, 64-bit mode </td>
<td align="left"> BOOT_CS64 (0x0010)</td>
</tr>
<tr>
<td align="left">3 </td>
<td align="left"> ring0 data </td>
<td align="left"> BOOT_DS (0x0018)</td>
</tr>
<tr>
<td align="left">4 </td>
<td align="left"> real-mode code </td>
<td align="left"> BOOT_PSEUDORM_CS (0x0020)</td>
</tr>
<tr>
<td align="left">5 </td>
<td align="left"> real-mode data </td>
<td align="left"> BOOT_PSEUDORM_DS (0x0028)</td>
</tr>
</tbody>
</table>


<ul>
<li>获取Multiboot相关的信息，放置在某段内存空间，之后启动的时候会被用到；</li>
<li>初始化BSS；</li>
<li>初始化最早期的页表<code>l3_bootmap</code>和<code>l2_bootmap</code>，注意这个时候还没有开启分页功能。这个部分会在后面进行详细介绍；</li>
<li>解析早期命令行参数；</li>
<li>调整<code>trampoline.S</code>代码的内存位置,移动到 BOOT_TRAMPOLINE(0x8c00处);</li>
<li>跳转到 trampoline_boot_cpu_entry。</li>
</ul>


<p><code>trampoline.S</code>，主要工作为：</p>

<ul>
<li>进入实模式,读取内存,磁盘,视频信息；</li>
<li>进入保护模式，将页表基地址<code>idle_pg_table</code>载入CR3，<code>idle_pg_table</code>会在之后进行详细的介绍；</li>
<li>开启EFER（Extended Feature Enable Register）；</li>
<li>开启分页模式，同时将<code>CR0</code>中的<code>PG, AM, WP, NE, ET, MP, PE</code>位都设上；</li>
<li>进入<code>__high_start</code>，即<code>x86_64.S</code>的代码。</li>
</ul>


<p><code>x86_64.S</code>，主要工作为：</p>

<ul>
<li>重新载入GDT (gdt_descr)：</li>
</ul>


<table>
<thead>
<tr>
<th align="left">GDT项 </th>
<th align="left"> 说明 </th>
<th align="left"> 段选择子</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">0xe001 </td>
<td align="left"> ring0 code, 64-bit mode </td>
<td align="left"> __HYPERVISOR_CS64 (0xe008)</td>
</tr>
<tr>
<td align="left">0xe002 </td>
<td align="left"> ring0 data </td>
<td align="left"> __HYPERVISOR_DS32 (0xe010)</td>
</tr>
<tr>
<td align="left">0xe003 </td>
<td align="left"> reserved </td>
<td align="left"> -</td>
</tr>
<tr>
<td align="left">0xe004 </td>
<td align="left"> ring 3 code, compatibility </td>
<td align="left"> FLAT_RING3_CS32 (0xe023)</td>
</tr>
<tr>
<td align="left">0xe005 </td>
<td align="left"> ring 3 data </td>
<td align="left"> FLAT_RING3_DS32 (0xe02b)</td>
</tr>
<tr>
<td align="left">0xe006 </td>
<td align="left"> ring 3 code, 64-bit mode </td>
<td align="left"> FLAT_RING3_CS64 (0xe033)</td>
</tr>
<tr>
<td align="left">0xe007 </td>
<td align="left"> ring 0 code, compatibility </td>
<td align="left"> __HYPERVISOR_CS32 (0xe038)</td>
</tr>
<tr>
<td align="left">0xe008~0xe009 </td>
<td align="left"> TSS </td>
<td align="left"> -</td>
</tr>
<tr>
<td align="left">0xe00a~0xe00b </td>
<td align="left"> LDT </td>
<td align="left"> -</td>
</tr>
<tr>
<td align="left">0xe00c </td>
<td align="left"> per-cpu entry </td>
<td align="left"> -</td>
</tr>
</tbody>
</table>


<ul>
<li>装入堆栈指针：</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mov</span> <span class="n">stack_start</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rsp</span>
</span><span class='line'><span class="n">or</span>  <span class="err">$</span><span class="p">(</span><span class="n">STACK_SIZE</span><span class="o">-</span><span class="n">CPUINFO_sizeof</span><span class="p">),</span><span class="o">%</span><span class="n">rsp</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意，Xen会通过<code>or $(STACK_SIZE-CPUINFO_sizeof),%rsp</code>方式在栈顶预留一个<code>cpu_info</code>结构，这个结构包含很多重要的成员：</p>

<pre><code>1. 客户系统的切换上下文 
2. 当前运行的`vcpu`指针
3. 物理处理器编号
...
</code></pre>

<ul>
<li>跳转到<code>__start_xen</code>。</li>
</ul>


<h4>C部分：</h4>

<p>即<code>xen-source/xen/arch/x86/setup.c</code>文件中的<code>__start_xen</code>函数，主要逻辑如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="n">__init</span> <span class="nf">__start_xen</span><span class="p">(</span><span class="n">multiboot_info_t</span> <span class="o">*</span><span class="n">mbi</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 注意,默认的情况下,参数 mbi 将从堆栈传递,这个值是前面汇编代码中的ebx值 </span>
</span><span class='line'>  <span class="c1">// 初始化IDT table</span>
</span><span class='line'>  <span class="c1">// 初始化系统相关table和描述符，包括TSS，GDT，LDT，TR等</span>
</span><span class='line'>  <span class="c1">// 解析命令行</span>
</span><span class='line'>  <span class="c1">// 初始化 console</span>
</span><span class='line'>  <span class="c1">// 内存初始化，这些是这篇博文的重点</span>
</span><span class='line'>  <span class="c1">// 其它的一些设备初始化</span>
</span><span class='line'>  <span class="c1">// trap_init,初始化 IDT</span>
</span><span class='line'>  <span class="c1">// CPU的初始化</span>
</span><span class='line'>  <span class="c1">// 创建domaim-0，下一篇博文的重点</span>
</span><span class='line'>  <span class="c1">// `domain_unpause_by_systemcontroller(dom0)`,调度domain-0 </span>
</span><span class='line'>  <span class="c1">// `reset_stack_and_jump(init_done)`，Xen进入idle循环</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<h3>内存初始化</h3>

<p>在介绍完Xen大致的的启动流程之后，我们就要开始来重点介绍和内存相关的具体实现了。以下的内容主要回答下面几个问题：</p>

<ul>
<li>Xen是如何从实模式启动，然后进入保护模式，并开启分页模式的？</li>
<li>Xen的页表是如何建立的？即如何建立虚拟内存到物理内存的映射？</li>
<li>Xen在启动过程中是如何进行内存分配的？</li>
<li>整个系统运行起来之后，Xen是如何管理自己的内存的？</li>
</ul>


<p>对于第一个问题，简单来说，Xen在启动的时候是处于实模式的，也就是可以直接访问物理内存，通过预先定义的ENTRY地址<code>start</code>开始执行最初的汇编代码。在开启分页机制之前，Xen会先初始化一段最基本的页表，即在页表中映射物理内存的0~16M地址空间，其中包括了Xen所需的最基本的代码和数据，然后通过设置<code>CR0</code>中的某些位开启分页机制。</p>

<p>为了回答余下的三个问题，我们先来看看Xen页表的组织结构：</p>

<figure class='code'><figcaption><span>xen/arch/x86/boot/x86_64.S </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">__page_tables_start</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">......</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Top-level master (and idle-domain) page directory. */</span>
</span><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">idle_pg_table</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l3_bootmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="n">L4_PAGETABLE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">l4_table_offset</span><span class="p">(</span><span class="n">DIRECTMAP_VIRT_START</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l3_identmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="p">.</span><span class="n">elseif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">l4_table_offset</span><span class="p">(</span><span class="n">XEN_VIRT_START</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l3_xenmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="p">.</span><span class="k">else</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endif</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">idle_pg_table</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">idle_pg_table</span>
</span><span class='line'>
</span><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">__page_tables_end</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>idle_pg_table</code>是页表的基地址，也就是第四级页表l4的地址，会在<code>trampoline.S</code>里，在开启分页机制之前被载入cr3：</p>

<figure class='code'><figcaption><span>trampoline.S </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="cm">/* Load pagetable base register. */</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="err">$</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">idle_pg_table</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'>        <span class="n">add</span>     <span class="n">bootsym_rel</span><span class="p">(</span><span class="n">trampoline_xen_phys_start</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span><span class="p">)</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">cr3</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，它的第0项是<code>l3_bootmap</code>：</p>

<figure class='code'><figcaption><span>x86_64.S </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">idle_pg_table</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l3_bootmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>l3_bootmap</code>和<code>l2_bootmap</code>在<code>head.S</code>启动代码里面被初始化了：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="cm">/* Initialise L2 boot-map page table entries (16MB). */</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="err">$</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_bootmap</span><span class="p">),</span><span class="o">%</span><span class="n">edx</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="err">$</span><span class="n">PAGE_HYPERVISOR</span><span class="o">|</span><span class="n">_PAGE_PSE</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="err">$</span><span class="mi">8</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span>      <span class="n">mov</span>     <span class="o">%</span><span class="n">eax</span><span class="p">,(</span><span class="o">%</span><span class="n">edx</span><span class="p">)</span>
</span><span class='line'>        <span class="n">add</span>     <span class="err">$</span><span class="mi">8</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
</span><span class='line'>        <span class="n">add</span>     <span class="err">$</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">L2_PAGETABLE_SHIFT</span><span class="p">),</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'>        <span class="n">loop</span>    <span class="mi">1</span><span class="n">b</span>
</span><span class='line'>        <span class="cm">/* Initialise L3 boot-map page directory entry. */</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="err">$</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_bootmap</span><span class="p">)</span><span class="o">+</span><span class="n">__PAGE_HYPERVISOR</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">l3_bootmap</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="o">*</span><span class="mi">8</span>
</span><span class='line'>        <span class="cm">/* Hook 4kB mappings of first 2MB of memory into L2. */</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="err">$</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">l1_identmap</span><span class="p">)</span><span class="o">+</span><span class="n">__PAGE_HYPERVISOR</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_xenmap</span><span class="p">)</span>
</span><span class='line'>        <span class="n">mov</span>     <span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_bootmap</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，<code>l3_bootmap</code>的第0项是<code>l2_bootmap</code>的地址，而<code>l2_bootmap</code>第0项是<code>l1_identmap</code>，它会以4K的页的方式映射0~2M的物理内存地址空间，而1~7项则是以7个2M的大页映射了2~16M的物理内存。而在这0~16M的物理内存中，存放了Xen的代码、数据的信息，需要在启动的时候被用到，所以需要在最初始的阶段映射到虚拟地址空间中。</p>

<p>继续看<code>idle_page_table</code>，如果<code>idx</code>为<code>l4_table_offset(XEN_VIRT_START)</code>，即第261项，则在该项填上<code>l3_xenmap</code>的地址；如果<code>idx</code>为<code>l4_table_offset(DIRECTMAP_VIRT_START)</code>，即第262项，则在该项上填上<code>l3_identmap</code>的地址，其余的地址在这个时候都被设置为0。</p>

<p>接下来我们来看看<code>l3_xenmap</code>和<code>l3_identmap</code>分别是什么：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">l2_xenmap</span><span class="p">)</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="mi">8</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">__image_base__</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">L2_PAGETABLE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_HYPERVISOR</span> <span class="o">|</span> <span class="n">_PAGE_PSE</span><span class="p">)</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fill</span> <span class="n">L2_PAGETABLE_ENTRIES</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">l2_xenmap</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">l2_xenmap</span>
</span><span class='line'>
</span><span class='line'><span class="nl">l3_xenmap:</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="n">L3_PAGETABLE_ENTRIES</span>
</span><span class='line'>        <span class="p">.</span><span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">l3_table_offset</span><span class="p">(</span><span class="n">XEN_VIRT_START</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_xenmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="p">.</span><span class="n">elseif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">l3_table_offset</span><span class="p">(</span><span class="n">FIXADDR_TOP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_fixmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="p">.</span><span class="k">else</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endif</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">l3_xenmap</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">l3_xenmap</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们这里只需要关注这个<code>l2_xenmap</code>，也就是<code>l3_xenmap</code>的第322项（l3_table_offset(XEN_VIRT_START)），里面0~7项以2M大页的方式映射了<code>__image_base__</code>的内容：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define sym_phys(sym)     ((sym) - __XEN_VIRT_START)</span>
</span><span class='line'>
</span><span class='line'><span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">__image_base__</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">L2_PAGETABLE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_HYPERVISOR</span> <span class="o">|</span> <span class="n">_PAGE_PSE</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以从<code>xen/arch/x86/xen.lds.S</code>文件中看到：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SECTIONS</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">.</span> <span class="o">=</span> <span class="n">__XEN_VIRT_START</span><span class="p">;</span>
</span><span class='line'>  <span class="n">__image_base__</span> <span class="o">=</span> <span class="p">.;</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说，<code>__image_base__</code>即为<code>__XEN_VIRT_START</code>的地址，所以，<code>l2_xenmap</code>映射的内存也是0~16M的物理内存。</p>

<p>再来看<code>l3_identmap</code>，可以从下面的代码看出来，<code>l3_identmap</code>的0~3项映射了4个连续的第二级页表页，以<code>l2_identmap</code>作为起始地址。而<code>l2_identmap</code>和<code>l2_bootmap</code>一样，也是第0项映射了一个L1的页表页<code>l1_identmap</code>，第1~7项以7个2M大页的形式映射了2~16M的物理内存。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* Mapping of first 16 megabytes of memory. */</span>
</span><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">l2_identmap</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l1_identmap</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="n">pfn</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="mi">7</span>
</span><span class='line'>        <span class="n">pfn</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PAGETABLE_ORDER</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PAGE_HYPERVISOR</span> <span class="o">|</span> <span class="n">_PAGE_PSE</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fill</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">L2_PAGETABLE_ENTRIES</span> <span class="o">-</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">l2_identmap</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">l2_identmap</span>
</span><span class='line'>
</span><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">l3_identmap</span><span class="p">)</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="mi">4</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_identmap</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fill</span> <span class="n">L3_PAGETABLE_ENTRIES</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">l3_identmap</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">l3_identmap</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后我们来看<code>l1_identmap</code>，它位于<code>xen/arch/x86/boot/head.S</code>文件中：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Mapping of first 2 megabytes of memory. This is mapped with 4kB mappings</span>
</span><span class='line'><span class="cm"> * to avoid type conflicts with fixed-range MTRRs covering the lowest megabyte</span>
</span><span class='line'><span class="cm"> * of physical memory. In any case the VGA hole should be mapped with type UC.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">l1_identmap</span><span class="p">)</span>
</span><span class='line'>        <span class="n">pfn</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="n">L1_PAGETABLE_ENTRIES</span>
</span><span class='line'>        <span class="cm">/* VGA hole (0xa0000-0xc0000) should be mapped UC. */</span>
</span><span class='line'>        <span class="p">.</span><span class="k">if</span> <span class="n">pfn</span> <span class="o">&gt;=</span> <span class="mh">0xa0</span> <span class="o">&amp;&amp;</span> <span class="n">pfn</span> <span class="o">&lt;</span> <span class="mh">0xc0</span>
</span><span class='line'>        <span class="p">.</span><span class="kt">long</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PAGE_HYPERVISOR_NOCACHE</span> <span class="o">|</span> <span class="n">MAP_SMALL_PAGES</span>
</span><span class='line'>        <span class="p">.</span><span class="k">else</span>
</span><span class='line'>        <span class="p">.</span><span class="kt">long</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PAGE_HYPERVISOR</span> <span class="o">|</span> <span class="n">MAP_SMALL_PAGES</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endif</span>
</span><span class='line'>        <span class="p">.</span><span class="kt">long</span> <span class="mi">0</span>
</span><span class='line'>        <span class="n">pfn</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">l1_identmap</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">l1_identmap</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到它其实就是以4K的正常页的方式映射了0~2M的物理内存地址空间。</p>

<p>到此为止，我们可以画一张最基本的页表分布图：</p>

<p><img src="http://ytliu.info/images/2015-07-30-1.png" title="xen boot pagetable 1" alt="xen boot pagetable 1" /></p>

<hr />

<p>好了，到现在为止，我们介绍了在进入<code>__start_xen</code>之前，页表是如何初始化的，在这个过程中，0~16M（即Xen的代码和数据）的物理内存被映射在了三段虚拟内存空间中，它们分别是：</p>

<ul>
<li>0~16M的的虚拟地址空间；</li>
<li>XEN_VIRT_STAET ~ XEN_VIRT_START + 16M，即0xffff82d080000000~0xffff82d081000000的虚拟地址空间中；</li>
<li>DIRECTMAP_VIRT_START ~ DIRECTMAP_VIRT_START + 16M，即0xffff830000000000~0xffff830001000000的虚拟地址空间中</li>
</ul>


<p>接下来，在<code>__start_xen</code>的代码中将对这段虚拟内存空间进行一次调整，并且将其他物理内存映射到相应的虚拟内存空间中，同时在不同的阶段初始化不同的内存分配器。具体来说，它将完成以下几个内存相关的步骤：</p>

<ul>
<li>获取E820物理内存分布；</li>
<li>将16M~4G的内存空间进行大页的映射，同时将0~16M的地址空间映射到更高的虚拟地址空间中；</li>
<li>计算modules（kernel和initrd）的地址，并且预留内存空间给它们；</li>
<li>遍历所有的物理内存，将它们映射到虚拟地址空间中，对于16M~4G的内存，会把原来的小页（4K page）也进行映射，并且通过<code>init_boot_pages</code>创建boot内存分配器，对于4G以上的内存，直接映射（1G，2M或者4K）的页；</li>
<li>将modules的内存映射到Xen的虚拟地址空间中；</li>
<li>初始化frametable；</li>
<li>end_boot_allocator，并且初始化堆分配器；</li>
<li>创建页表中其它虚拟地址空间的映射；</li>
<li>初始化Domain-0的内存</li>
</ul>


<p>除了最后一个步骤，其它步骤都会在接下来的部分进行介绍。</p>

<h4>获取E820物理内存分布</h4>

<p>什么是E820？其实就是BIOS的一个中断（具体来说是<code>int 0x15</code>），在触发这个中断时如果<code>EAX</code>是<code>0xe820</code>，那么BIOS就能返回系统的物理内存布局。由于系统内存会有很多段，而且每段的类型属性也不一样，所以我们得到的E820内存分布也被分成了很多个不同类型的内存段。</p>

<p>在Xen的<code>__start_xen</code>代码里，会通过下列代码来打印出当前系统物理内存的分段情况：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="cm">/* Sanitise the raw E820 map to produce a final clean version. */</span>
</span><span class='line'>    <span class="n">max_page</span> <span class="o">=</span> <span class="n">raw_max_page</span> <span class="o">=</span> <span class="n">init_e820</span><span class="p">(</span><span class="n">memmap_type</span><span class="p">,</span> <span class="n">e820_raw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e820_raw_nr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Create a temporary copy of the E820 map. */</span>
</span><span class='line'>    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">boot_e820</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e820</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e820</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过命令：</p>

<pre><code>$ xl dmesg
</code></pre>

<p>可以看到系统E820的分布情况，比如我的E820是这样的：</p>

<p><img src="http://ytliu.info/images/2015-07-30-2.png" title="xen e820" alt="xen e820" /></p>

<p>这是我在自己计算机上启动Xen所得到的数据，其中usable的区间就是实际被映射到物理内存上的地址空间，可以看到在我的例子中有七个可用的物理地址区间，大约32GB：</p>

<pre><code>0000000000000000 - 0000000000058000 (usable) ~352K
0000000000059000 - 00000000000a0000 (usable) ~156K
0000000000100000 - 00000000a63d9000 (usable) ~2659M
00000000a63e0000 - 00000000a7404000 (usable) ~4M
00000000a7961000 - 00000000b9f97000 (usable) ~295M
00000000bafff000 - 00000000bb000000 (usable) ~4K
0000000100000000 - 000000083f600000 (usable) ~29686M
</code></pre>

<p>其它几个选项代表不同的意思，如下所示（参考<a href="http://deltamaster.is-programmer.com/posts/37297.html">这里</a>）：</p>

<ul>
<li>Usable：已经被映射到物理内存的物理地址；</li>
<li>Reserved：这些区间是没有被映射到任何地方，不能当作RAM来使用，但是kernel可以决定将这些区间映射到其他地方，比如PCI设备。通过检查<code>/proc/iomem</code>这个虚拟文件，就可以知道这些reserved的空间，是如何进一步分配给不同的设备来使用了。</li>
<li>ACPI data：映射到用来存放ACPI数据的RAM空间，操作系统应该将ACPI Table读入到这个区间内。</li>
<li>ACPI NVS：映射到用来存放ACPI数据的非易失性存储空间，操作系统不能使用。</li>
<li>Unusable：表示检测到发生错误的物理内存。这个在上面例子里没有，因为比较少见。</li>
</ul>


<p>得到这些物理内存的分布之后，我们就需要将可用（usable）的那些映射到对应的虚拟地址空间中了。</p>

<h4>第一轮映射</h4>

<p>在第一轮映射中，主要是将16M~4G的物理内存以大页（2M page）的形式映射到对应的虚拟地址空间，同时将0~16M的地址空间从原来的0~16M的虚拟地址空间映射到更高的虚拟地址空间中，这是由于一些兼容性的原因，因为大部分系统0~16M虚拟地址空间是有其它作用的。</p>

<p>这一段代码非常复杂，这里就不详细说明了，主要是要注意以下几点：</p>

<ul>
<li>这里有两个阈值：<code>BOOTSTRAP_MAP_BASE</code>和<code>limit</code>：</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define BOOTSTRAP_MAP_BASE (16UL &lt;&lt; 20)</span>
</span><span class='line'><span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">l2_identmap</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2_PAGETABLE_SHIFT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>它们最后的取值分别是16M和4G。当物理内存地址位于16M~4G时，且是usable的时候，会通过<code>map_pages_to_xen</code>函数将它们map到对应的虚拟内存中：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">BOOTSTRAP_MAP_BASE</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">boot_e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">E820_RAM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
</span><span class='line'>            <span class="n">set_pdx_range</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
</span><span class='line'>            <span class="n">map_pages_to_xen</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
</span><span class='line'>                             <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>正如在<a href="http://ytliu.info/blog/2015/07/28/xende-nei-cun-bu-ju/">上篇博客</a>提到过的，这里<code>__va(s)</code>即将物理地址s映射在direct map的那一段内存中：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">__maddr_to_virt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ma</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ASSERT</span><span class="p">(</span><span class="n">pfn_to_pdx</span><span class="p">(</span><span class="n">ma</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">DIRECTMAP_SIZE</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">DIRECTMAP_VIRT_START</span> <span class="o">+</span>
</span><span class='line'>                    <span class="p">((</span><span class="n">ma</span> <span class="o">&amp;</span> <span class="n">ma_va_bottom_mask</span><span class="p">)</span> <span class="o">|</span>
</span><span class='line'>                     <span class="p">((</span><span class="n">ma</span> <span class="o">&amp;</span> <span class="n">ma_top_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">pfn_pdx_hole_shift</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define maddr_to_virt(ma)   __maddr_to_virt((unsigned long)(ma))</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define __va(x)             (maddr_to_virt(x))</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以所有16M~4G的物理内存<code>s</code>都被映射在了<code>s+DIRECTMAP_VIRT_START</code>的那段虚拟内存中，比如物理内存<code>0x1000000</code>(16M)被映射在了<code>0xffff830001000000</code>虚拟地址上。</p>

<ul>
<li>另外一点需要注意的是，在这个过程中，并不需要分配新的页表，而且在这个阶段并没有初始化任何内存分配器，所以也无法分配新的内存页来作为页表。那么它是如何做到这点的呢？</li>
</ul>


<p>如果对之前提到的页表有印象的话，应该还记得，我们在<code>l3_identmap</code>中创建了4个<code>l2_identmap</code>页表项：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GLOBAL</span><span class="p">(</span><span class="n">l3_identmap</span><span class="p">)</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">rept</span> <span class="mi">4</span>
</span><span class='line'>        <span class="p">.</span><span class="n">quad</span> <span class="n">sym_phys</span><span class="p">(</span><span class="n">l2_identmap</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="n">__PAGE_HYPERVISOR</span>
</span><span class='line'>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">.</span><span class="n">endr</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fill</span> <span class="n">L3_PAGETABLE_ENTRIES</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span> <span class="n">l3_identmap</span><span class="p">,</span> <span class="p">.</span> <span class="o">-</span> <span class="n">l3_identmap</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中只有第一个<code>l2_identmap</code>的前8项（0~16M）被初始化了，而其余的并没有初始化。一个常识是，每一个L3页表项代表了1个G的内存，那么我们有4个L3的页表项，那么就代表了4G的内存！而且所有这些页表项指向的L2的页表也已经存在了，所以说不需要重新分配新的页表页，就能够处理4G以内的所有以大页形式描述的内存了。</p>

<ul>
<li>最后一个问题，也就是如何将0~16M的物理内存映射到更高的虚拟地址空间中？</li>
</ul>


<p>在这里我就不具体说它是如何重映射的了，无非就是找到一个连续的地址空间，然后将内存从0~16M拷贝到新的地址空间，并且将原来的page table entries的内容拷贝到新的page table entries。这里来说下它是如何选择这块新的虚拟地址空间的：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define reloc_size ((__pa(&amp;_end) + mask) &amp; ~mask)</span>
</span><span class='line'>        <span class="cm">/* Is the region suitable for relocating Xen? */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">xen_phys_start</span> <span class="o">&amp;&amp;</span> <span class="n">e</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* Don&#39;t overlap with modules. */</span>
</span><span class='line'>            <span class="n">end</span> <span class="o">=</span> <span class="n">consider_modules</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reloc_size</span> <span class="o">+</span> <span class="n">mask</span><span class="p">,</span>
</span><span class='line'>                                   <span class="n">mod</span><span class="p">,</span> <span class="n">mbi</span><span class="o">-&gt;</span><span class="n">mods_count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>            <span class="n">end</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">s</span> <span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">l4_pgentry_t</span> <span class="o">*</span><span class="n">pl4e</span><span class="p">;</span>
</span><span class='line'>            <span class="n">l3_pgentry_t</span> <span class="o">*</span><span class="n">pl3e</span><span class="p">;</span>
</span><span class='line'>            <span class="n">l2_pgentry_t</span> <span class="o">*</span><span class="n">pl2e</span><span class="p">;</span>
</span><span class='line'>            <span class="kt">uint64_t</span> <span class="n">load_start</span><span class="p">;</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="cm">/* Select relocation address. */</span>
</span><span class='line'>            <span class="n">e</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">reloc_size</span><span class="p">;</span>
</span><span class='line'>            <span class="n">xen_phys_start</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">load_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">_start</span> <span class="o">-</span> <span class="n">XEN_VIRT_START</span><span class="p">;</span>
</span><span class='line'>            <span class="n">barrier</span><span class="p">();</span>
</span><span class='line'>            <span class="n">move_memory</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="n">load_start</span><span class="p">,</span> <span class="n">load_start</span><span class="p">,</span> <span class="n">_end</span> <span class="o">-</span> <span class="n">_start</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>            <span class="p">...</span>
</span><span class='line'>            <span class="c1">// update page tables and reload cr3 to invalidate TLB.</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有几个重要的变量：<code>end</code>，<code>reloc_size</code>。</p>

<p>对于<code>end</code>：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>            <span class="n">end</span> <span class="o">=</span> <span class="n">consider_modules</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">reloc_size</span> <span class="o">+</span> <span class="n">mask</span><span class="p">,</span>
</span><span class='line'>                                   <span class="n">mod</span><span class="p">,</span> <span class="n">mbi</span><span class="o">-&gt;</span><span class="n">mods_count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们暂且不需要知道<code>consider_modules</code>是如何计算的，这个步骤主要是要得出在0~4G的物理地址空间中，最大的那个usable的，并且是2M对其的那个地址。从E820可以看出，4G之内最大的那个地址段是<code>00000000a7961000 - 00000000b9f97000</code>，而里面最大的2M对齐的地址即为<code>0xb9e00000</code>。</p>

<p>而对于<code>reloc_size</code>：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define reloc_size ((__pa(&amp;_end) + mask) &amp; ~mask)</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>_end</code>是Xen的代码和数据段的结束的地址，它在<code>xen.lds.S</code>中定义，它表示的是xen的所有代码和数据的最大的内存地址。所以<code>reloc_size</code>即表示xen的代码和数据段所占的内存空间有多大（最后会被1M向上对齐）。在我的系统中，它是0x400000，即4M的大小。</p>

<p>所以，这段需要被relocate的地址<code>xen_phys_start</code>即为<code>end - reloc_size</code>，所以说，Xen的代码和数据段最后被重映射到了4G内存之内的最大的地址空间中。可以看到，Xen先通过<code>move_memory</code>将内容拷贝到高地址，然后再更新页表。</p>

<h4>第二轮映射</h4>

<p>在第二轮映射中，它会遍历所有的物理内存（包括小于16M和大于4G的内存），将它们映射到虚拟地址空间中。对于0~4G的内存，会把原来未映射的小页（4K page）也进行映射，而对于4G以上的内存，则直接映射（1G，2M或者4K）的页。并且它还通过<code>init_boot_pages</code>将所有可用的物理页加入数据结构<code>bootmem_region_list</code>中，建立boot内存分配器，用于在boot阶段分配内存。</p>

<p>这是这段代码的主体部分。在这段代码中有好多个条件判断，主要作用就是将需要映射的物理内存的地址范围做一个划分，我们通过注释来说明这个过程。</p>

<p>首先通过一张图来更好地解释其划分的依据：</p>

<p><img src="http://ytliu.info/images/2015-07-30-3.png" title="xen memory mapping helper" alt="xen memory mapping helper" /></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">boot_e820</span><span class="p">.</span><span class="n">nr_map</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">uint64_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 最小对齐为4K页粒度 */</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">boot_e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* 起始地址4K向上对齐 */</span>
</span><span class='line'>        <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">boot_e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">boot_e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* 尾地址4K向下对齐 */</span>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">);</span> <span class="cm">/* 1M地址以内的不进行考虑 */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">boot_e820</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">E820_RAM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="p">)</span> <span class="p">)</span> <span class="cm">/* 只考虑usable的内存 */</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">set_pdx_range</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">e</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span> <span class="cm">/* 设置pdx_range，之后具体介绍 */</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* 以下开始对内存范围进行划分，划分的两个重要依据是图中的A点（16M）和B点（4G） */</span>
</span><span class='line'>        <span class="n">map_s</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">BOOTSTRAP_MAP_BASE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">map_e</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">l2_identmap</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">L2_PAGETABLE_SHIFT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">init_boot_pages</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span> <span class="cm">/* 先将A点以下的内存区域加入boot分配器 */</span>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="n">map_s</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">map_e</span> <span class="p">)</span> <span class="cm">/* 将A点到e或者B点（如果e大于B点）的大页内存区域加入boot分配器 */</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">uint64_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">L2_PAGETABLE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">map_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* 首地址2M向上对齐 */</span>
</span><span class='line'>            <span class="n">map_e</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* 尾地址2M向下对齐 */</span>
</span><span class='line'>            <span class="n">init_boot_pages</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="n">map_e</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">map_s</span> <span class="o">&gt;</span> <span class="n">map_e</span> <span class="p">)</span> <span class="cm">/* 如果内存范围在A点之内，则这个过程结束 */</span>
</span><span class='line'>            <span class="n">map_s</span> <span class="o">=</span> <span class="n">map_e</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">map_e</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="p">)</span>  <span class="cm">/* 如果e位在B点之上 */</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">uint64_t</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">__pa</span><span class="p">(</span><span class="n">HYPERVISOR_VIRT_END</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="kt">uint64_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="n">map_e</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="p">)</span> <span class="cm">/* 先映射B点到HYPERVISOR_VIRT_END的地址空间，并且将其加入boot内存分配器 */</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">map_pages_to_xen</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">map_e</span><span class="p">),</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">map_e</span><span class="p">),</span>
</span><span class='line'>                                 <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">map_e</span><span class="p">),</span> <span class="n">PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>                <span class="n">init_boot_pages</span><span class="p">(</span><span class="n">map_e</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
</span><span class='line'>                <span class="n">map_e</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">map_e</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="p">)</span> <span class="cm">/* 映射HYPERVISOR_VIRT_END到e的地址空间 */</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* This range must not be passed to the boot allocator and</span>
</span><span class='line'><span class="cm">             * must also not be mapped with _PAGE_GLOBAL. */</span>
</span><span class='line'>            <span class="n">map_pages_to_xen</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">map_e</span><span class="p">),</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">map_e</span><span class="p">),</span>
</span><span class='line'>                             <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">map_e</span><span class="p">),</span> <span class="n">__PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">map_s</span> <span class="p">)</span> <span class="cm">/* 将A点到B点的4K页内存区域进行映射，并且加入boot分配器 */</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">map_pages_to_xen</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
</span><span class='line'>                             <span class="p">(</span><span class="n">map_s</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>            <span class="n">init_boot_pages</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">map_s</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以这就是划分不同的内存段进行映射，并且将可用的内存加入boot分配器。由于0~4G的内存区域中的2M的大页已经在之前被映射了，所以在这个阶段主要就是把它们加入boot分配器，同时映射4G以上的内存区域。</p>

<p>下面我们来重点分析3个函数：</p>

<ul>
<li><code>set_pdx_range</code></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PDX_GROUP_SHIFT L2_PAGETABLE_SHIFT</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PDX_GROUP_COUNT ((1 &lt;&lt; PDX_GROUP_SHIFT) / \</span>
</span><span class='line'><span class="cp">                         (sizeof(*frame_table) &amp; -sizeof(*frame_table)))</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">set_pdx_range</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">smfn</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">emfn</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">,</span> <span class="n">eidx</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">idx</span> <span class="o">=</span> <span class="n">pfn_to_pdx</span><span class="p">(</span><span class="n">smfn</span><span class="p">)</span> <span class="o">/</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">;</span>
</span><span class='line'>    <span class="n">eidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pfn_to_pdx</span><span class="p">(</span><span class="n">emfn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">)</span> <span class="o">/</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">eidx</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">__set_bit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pdx_group_valid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是啥意思呢？比较好理解的是，<code>PDX_GROUP_COUNT</code>表示的是在一个L2大页（2M）的内存中可以装多少个<code>frame_table</code>数据结构。这里有一个比较tricky的地方，就是这个<code>(sizeof(*frame_table) &amp; -sizeof(*frame_table))</code>。这里顺便普及一个知识：</p>

<blockquote><p>“x &amp; -x” means that the greatest power of 2 that is a factor of x.</p></blockquote>

<p>在我们这里，<code>sizeof(*frame_table)</code>的值是0x20，所以<code>PDX_GROUP_COUNT</code>即为<code>0x10000（64K）</code>。</p>

<p>另外如果跟进代码的话会发现，<code>pfn_to_pdx(pfn)</code>其实就是<code>pfn</code>，所以<code>set_pdx_range</code>即找到<code>smfn</code>到<code>emfn</code>所对应的那些2M的大页，并且把<code>pdx_group_valid</code>中对应的bit给设上，表示说这些内存空间对应的pdx是valid的，这在之后有用。</p>

<ul>
<li><code>init_boot_pages</code></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">bootmem_region_add</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">bootmem_region_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>        <span class="n">bootmem_region_list</span> <span class="o">=</span> <span class="n">mfn_to_virt</span><span class="p">(</span><span class="n">s</span><span class="o">++</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="n">e</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_bootmem_regions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">bootmem_region_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">e</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bootmem_region_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bootmem_region_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span class='line'>            <span class="p">(</span><span class="n">nr_bootmem_regions</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bootmem_region_list</span><span class="p">));</span>
</span><span class='line'>    <span class="n">bootmem_region_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bootmem_region</span><span class="p">)</span> <span class="p">{</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="p">};</span>
</span><span class='line'>    <span class="n">nr_bootmem_regions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_boot_pages</span><span class="p">(</span><span class="n">paddr_t</span> <span class="n">ps</span><span class="p">,</span> <span class="n">paddr_t</span> <span class="n">pe</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ps</span> <span class="o">=</span> <span class="n">round_pgup</span><span class="p">(</span><span class="n">ps</span><span class="p">);</span>
</span><span class='line'>    <span class="n">pe</span> <span class="o">=</span> <span class="n">round_pgdown</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">pe</span> <span class="o">&lt;=</span> <span class="n">ps</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bootmem_region_add</span><span class="p">(</span><span class="n">ps</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">pe</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码非常简单，就是将ps到pe的内存空间给加到<code>bootmem_region_list</code>中，之后进行分配内存的时候会被用到。</p>

<ul>
<li><code>map_pages_to_xen</code></li>
</ul>


<p>这个函数特别复杂，也是Xen里面非常重要的一个函数：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">map_pages_to_xen</span><span class="p">(</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mfn</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_mfns</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">......</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里就不展开来说，它所做的就是将以<code>virt</code>开头的<code>nr_mfns</code>个页映射到<code>mfn</code>的物理地址空间中。它的做法就是从<code>idle_page_table</code>开始走页表，最后凑齐所有的龙珠，哦不，所有的页表，然后在最后一级页表对应的页表项上写上mfn及其相应的flags。需要注意的是，它会根据你的虚拟地址来判断是否要用大页，以及用多大的大页（1G or 2M）。当然，如果需要新建一个页表，在boot阶段会通过<code>alloc_boot_pages(nr_pfns, pfn_align)</code>来分配对应的内存页：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">alloc_boot_pages</span><span class="p">(</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_pfns</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn_align</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nr_bootmem_regions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">bootmem_region</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bootmem_region_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>        <span class="n">pg</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">-</span> <span class="n">nr_pfns</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pfn_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">pg</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">s</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">_e</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">;</span>
</span><span class='line'>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="n">pg</span><span class="p">;</span>
</span><span class='line'>        <span class="n">bootmem_region_add</span><span class="p">(</span><span class="n">pg</span> <span class="o">+</span> <span class="n">nr_pfns</span><span class="p">,</span> <span class="n">_e</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">pg</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BOOT_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实也就是从我们之前通过<code>init_boot_pages</code>加到<code>bootmem_region_list</code>的内存来获取相应的内存页。这里就不详述了。</p>

<h4>modules（kernel，initrd）的内存映射</h4>

<p>这个步骤非常简单，就是运行了下面这段代码：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mbi</span><span class="o">-&gt;</span><span class="n">mods_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">set_pdx_range</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod_start</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod_start</span> <span class="o">+</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod_end</span><span class="p">));</span>
</span><span class='line'>        <span class="n">map_pages_to_xen</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mfn_to_virt</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod_start</span><span class="p">),</span>
</span><span class='line'>                         <span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod_start</span><span class="p">,</span>
</span><span class='line'>                         <span class="n">PFN_UP</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mod_end</span><span class="p">),</span> <span class="n">PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些函数之前都介绍过了，这里就不具体讲了。一般情况下，系统中会有两个modules，一个是kernel，还有一个是initrd，所以这个循环会进行两次，每次将不同的module映射到对应的地址空间。</p>

<h4><code>page_info</code>数据结构列表FrameTable的初始化</h4>

<p>这个过程对应的函数是<code>init_frametable</code>：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_frametable_chunk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">start</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">e</span><span class="p">;</span> <span class="n">s</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">step</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cpu_has_page1gb</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                       <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">L3_PAGETABLE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span>
</span><span class='line'>                       <span class="n">L3_PAGETABLE_SHIFT</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span> <span class="o">:</span>
</span><span class='line'>                       <span class="n">L2_PAGETABLE_SHIFT</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span> <span class="n">step</span> <span class="o">&amp;&amp;</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">step</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">e</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">step</span> <span class="o">&gt;&gt;=</span> <span class="n">PAGETABLE_ORDER</span><span class="p">;</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">mfn</span> <span class="o">=</span> <span class="n">alloc_boot_pages</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">mfn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">step</span> <span class="o">&gt;&gt;=</span> <span class="n">PAGETABLE_ORDER</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">mfn</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">panic</span><span class="p">(</span><span class="s">&quot;Not enough memory for frame table&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">map_pages_to_xen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mfn</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span> <span class="o">-</span> <span class="n">e</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_frametable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_pdx</span> <span class="o">+</span> <span class="n">PDX_GROUP_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">sidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">sidx</span> <span class="o">=</span> <span class="n">nidx</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">eidx</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">pdx_group_valid</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">,</span> <span class="n">sidx</span><span class="p">);</span>
</span><span class='line'>        <span class="n">nidx</span> <span class="o">=</span> <span class="n">find_next_bit</span><span class="p">(</span><span class="n">pdx_group_valid</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">,</span> <span class="n">eidx</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">nidx</span> <span class="o">&gt;=</span> <span class="n">max_idx</span> <span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="n">init_frametable_chunk</span><span class="p">(</span><span class="n">pdx_to_page</span><span class="p">(</span><span class="n">sidx</span> <span class="o">*</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">),</span>
</span><span class='line'>                              <span class="n">pdx_to_page</span><span class="p">(</span><span class="n">eidx</span> <span class="o">*</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">end_pg</span> <span class="o">=</span> <span class="n">pdx_to_page</span><span class="p">(</span><span class="n">max_pdx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">top_pg</span> <span class="o">=</span> <span class="n">mem_hotplug</span> <span class="o">?</span> <span class="n">pdx_to_page</span><span class="p">(</span><span class="n">max_idx</span> <span class="o">*</span> <span class="n">PDX_GROUP_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>                         <span class="o">:</span> <span class="n">end_pg</span><span class="p">;</span>
</span><span class='line'>    <span class="n">init_frametable_chunk</span><span class="p">(</span><span class="n">pdx_to_page</span><span class="p">(</span><span class="n">sidx</span> <span class="o">*</span> <span class="n">PDX_GROUP_COUNT</span><span class="p">),</span> <span class="n">top_pg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">end_pg</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">top_pg</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">end_pg</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在搞清楚这段代码之前，我们需要先有一个概念。frametable其实是位于<code>0xffff82e000000000 - 0xffff82ffffffffff</code>内存中的一堆<code>struct page_info</code>的数据结构，每一个<code>page_info</code>记录了一个物理页的相应的信息。另外，之前提到的那个<code>pdx</code>，全称为<code>page descriptor index</code>，在我的机器上，有大约32G的内存，也就是从<code>0x0~0x83f600000</code>。前面计算过<code>PDX_GROUP_COUNT</code>为<code>0x10000</code>，所以在我的机器中最大的pdx即为<code>0x83f600000 &gt;&gt; 12 &gt;&gt; 16 = 84</code>（向上对齐）。</p>

<p>所以这段代码就是找到从0到84中所有在之前通过<code>set_pdx_range</code>设上的pdx，然后将其映射到对应的<code>page_info</code>的内存上。在我的机器上，<code>0x0~0xc</code>，以及<code>0x10~0x84</code>是在之前通过<code>set_pdx_range</code>设上的pdx，所以通过<code>init_frametable_chunk</code>将它们对应的<code>page_info</code>映射到frametable的虚拟地址空间中。</p>

<ul>
<li>堆分配器的初始化</li>
</ul>


<p>在前面的所有操作完成之后，<code>__start_xen</code>会调用<code>end_boot_allocator()</code>：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="n">__init</span> <span class="nf">end_boot_allocator</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nr_bootmem_regions</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">bootmem_region</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bootmem_region_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">e</span> <span class="p">)</span>
</span><span class='line'>            <span class="n">init_heap_pages</span><span class="p">(</span><span class="n">mfn_to_page</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">init_heap_pages</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">bootmem_region_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>它会调用<code>init_heap_pages</code>初始化堆分配器。</p>

<p>堆分配器是Xen的主内存分配器,这是一个和Linux的内存分配器类似的分配器。这里就不对其进行介绍了，反正之后的内存分配都是依靠这个堆分配器了。</p>

<ul>
<li>其它虚拟地址空间在页表中的映射</li>
</ul>


<p>到此为止，变量<code>system_state</code>已经从<code>SYS_STATE_early_boot</code>变成了<code>SYS_STATE_boot</code>。之后所有的内存分配也从boot allocator变成了<code>alloc_xenheap_page()</code>或者<code>alloc_domheap_page()</code>。另外Xen已经将所有的物理内存都映射到了<code>DIRECTMAP_VIRT_START</code>到<code>DIRECTMAP_VIRT_END</code>之间。</p>

<p>接下来就是对虚拟地址空间中其它区域进行映射。在<a href="http://ytliu.info/blog/2015/07/28/xende-nei-cun-bu-ju/">上篇博客</a>里面提到在Xen的虚拟地址空间中还有好多其它区域，比如MPT，vmap等。这些区域也需要在xen启动的时候进行初始化，主要通过下面两个函数：</p>

<ul>
<li><code>vm_init()</code>：</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">vm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">va</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">vm_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">VMAP_VIRT_START</span><span class="p">;</span>
</span><span class='line'>     <span class="n">vm_end</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">arch_vmap_virt_end</span><span class="p">()</span> <span class="o">-</span> <span class="n">vm_base</span><span class="p">);</span>
</span><span class='line'>     <span class="n">vm_low</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">((</span><span class="n">vm_end</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>     <span class="n">nr</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">((</span><span class="n">vm_low</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>     <span class="n">vm_top</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vm_bitmap</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span> <span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>         <span class="k">struct</span> <span class="n">page_info</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span> <span class="n">alloc_domheap_page</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">map_pages_to_xen</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">page_to_mfn</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PAGE_HYPERVISOR</span><span class="p">);</span>
</span><span class='line'>         <span class="n">clear_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">va</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>     <span class="n">bitmap_fill</span><span class="p">(</span><span class="n">vm_bitmap</span><span class="p">,</span> <span class="n">vm_low</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>     <span class="cm">/* Populate page tables for the bitmap if necessary. */</span>
</span><span class='line'>     <span class="n">map_pages_to_xen</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vm_low</span> <span class="o">-</span> <span class="n">nr</span><span class="p">,</span> <span class="n">MAP_SMALL_PAGES</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>vm_init()</code>主要就是映射一部分物理内存到VMAP_VIRT_START开始的一段虚拟地址空间中。</p>

<ul>
<li><code>paging_init()</code></li>
</ul>


<p>这个函数复杂很多，它主要用来map好几个不同的machine-to-physical table (MPT)，这些MPT我目前为止还不太清楚用来做什么，之后慢慢补上，以及创建linear guest page table。这里就不详述了。</p>

<p>到目前为止，Xen启动阶段内存的虚拟化就告一段落了，接下来就要进行CPU、设备的初始化，以及Domain-0的创建了。关于Domain-0的创建会在下一篇博文中进行介绍。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Liu Yutao</span></span>

      








  


<time datetime="2015-07-30T21:36:00+08:00" pubdate data-updated="true">Jul 30<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/system/'>System</a>, <a class='category' href='/blog/categories/virtualization/'>Virtualization</a>, <a class='category' href='/blog/categories/xen/'>Xen</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    
  <h2>Share</h2>  
  <!-- JiaThis Button BEGIN -->  
<div class="jiathis_style_32x32">  
  <a class="jiathis_button_tsina"></a>  
  <a class="jiathis_button_tqq"></a>  
  <a class="jiathis_button_weixin"></a>  
  <a class="jiathis_button_renren"></a>  
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>  
  <a class="jiathis_counter_style"></a>  
</div>  
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1367457337064293" charset="utf-8"></script>  
<!-- JiaThis Button END -->  
  
    
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/07/28/xende-nei-cun-bu-ju/" title="Previous Post: Xen的内存布局">&laquo; Xen的内存布局</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/09/03/chu-shi-wifi-pineapple/" title="Next Post: 初识Wifi Pineapple">初识Wifi Pineapple &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p align="middle"><img src="http://ytliu.info/images/mypic.jpg" alt="Liu Yutao" width="60%" /></p>
  <p>My name is Liu Yutao and this is my blog. I am a Ph.D candidate in <a href="http://ipads.se.sjtu.edu.cn/" >IPADS</a> of SJTU, and this is my <a href="http://ipads.se.sjtu.edu.cn/doku.php?id=pub:members:yutao_liu">Homepage</a>.</p>
  <p>E-mail me at mctrain016@gmail.com if you have any questions or comments.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/12/15/sa-fan-na-xiao-zhen-shang-de-osdi2016/">萨凡纳小镇上的OSDI-2016——SJTU-IPADS的集体见闻（转载）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/10/x86zhi-ling-bian-ma-de-na-xie-shi-er/">X86指令编码的那些事儿</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/30/segmentation-protection-in-intel-processor/">Segmentation Protection in Intel Processor</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/16/tlbde-na-xie-shi-er/">TLB的那些事儿</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/15/linuxnei-cun-chu-shi-hua-c/">Linux内存初始化（C语言部分）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/14/linuxnei-cun-chu-shi-hua-assembly/">Linux内存初始化（汇编部分）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/01/wo-de-2015/">我的2015</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/14/enable-config-module-in-cyanogenmod-kernel/">Enable CONFIG_MODULE in Cyanogenmod Kernel</a>
      </li>
    
  </ul>
</section>

<section>
<h1>Categories</h1>
<span class='categories_tag'> <a href='/blog/categories/algorithm' style='font-size: 102.22222222222223%'>Algorithm(1)</a>  <a href='/blog/categories/android' style='font-size: 144.44444444444446%'>Android(20)</a>  <a href='/blog/categories/architecture' style='font-size: 104.44444444444444%'>Architecture(2)</a>  <a href='/blog/categories/attack' style='font-size: 115.55555555555556%'>Attack(7)</a>  <a href='/blog/categories/conference' style='font-size: 120.0%'>Conference(9)</a>  <a href='/blog/categories/git' style='font-size: 104.44444444444444%'>Git(2)</a>  <a href='/blog/categories/journey' style='font-size: 104.44444444444444%'>Journey(2)</a>  <a href='/blog/categories/kvm' style='font-size: 102.22222222222223%'>Kvm(1)</a>  <a href='/blog/categories/kvm' style='font-size: 104.44444444444444%'>Kvm(2)</a>  <a href='/blog/categories/life' style='font-size: 151.11111111111111%'>Life(23)</a>  <a href='/blog/categories/linux' style='font-size: 128.88888888888889%'>Linux(13)</a>  <a href='/blog/categories/mac' style='font-size: 102.22222222222223%'>Mac(1)</a>  <a href='/blog/categories/network' style='font-size: 111.11111111111111%'>Network(5)</a>  <a href='/blog/categories/ocaml' style='font-size: 102.22222222222223%'>Ocaml(1)</a>  <a href='/blog/categories/opennebula' style='font-size: 102.22222222222223%'>Opennebula(1)</a>  <a href='/blog/categories/others' style='font-size: 108.88888888888889%'>Others(4)</a>  <a href='/blog/categories/paper' style='font-size: 108.88888888888889%'>Paper(4)</a>  <a href='/blog/categories/qemu' style='font-size: 104.44444444444444%'>Qemu(2)</a>  <a href='/blog/categories/ror' style='font-size: 102.22222222222223%'>Ror(1)</a>  <a href='/blog/categories/ruby' style='font-size: 106.66666666666667%'>Ruby(3)</a>  <a href='/blog/categories/security' style='font-size: 137.77777777777777%'>Security(17)</a>  <a href='/blog/categories/study' style='font-size: 104.44444444444444%'>Study(2)</a>  <a href='/blog/categories/system' style='font-size: 160.0%'>System(27)</a>  <a href='/blog/categories/tool' style='font-size: 113.33333333333333%'>Tool(6)</a>  <a href='/blog/categories/tutorial' style='font-size: 115.55555555555556%'>Tutorial(7)</a>  <a href='/blog/categories/virtualization' style='font-size: 113.33333333333333%'>Virtualization(6)</a>  <a href='/blog/categories/xen' style='font-size: 111.11111111111111%'>Xen(5)</a> </span>
</section>

<section>
  <h1>Links</h1>
  <ul id="recent_posts">
      <li class="post">
        <a href="http://beader.me">Beader's blog</a>
      </li>
      <li class="post">
        <a href="http://edgeofmap.com/blog/">Edge of map</a>
      </li>
      <li class="post">
        <a href="http://www.freebuf.com/">Freebuf</a>
      </li>
      <li class="post">
        <a href="http://www.claudxiao.net/">i, Claud</a>
      </li>
      <li class="post">
        <a href="http://insight-labs.org/">Insight-labs</a>
      </li>
      <li class="post">
        <a href="http://insight-labs.org/wiki/index.php">Insight-labs Wiki</a>
      </li>
      <li class="post">
        <a href="http://hanjc.me">HAN</a>
      </li>
      <li class="post">
        <a href="http://www.liwenhaosuper.com/">Li Wenhao' weblog</a>
      </li>
      <li class="post">
        <a href="http://wiki.secmobi.com/home">SecMobi</a>
      </li>
      <li class="post">
        <a href="http://mytrix.me/">the 3rd. Place</a>
      </li>
      <li class="post">
        <a href="http://theuniverse.byethost32.com/">基巴斯坦</a>
      </li>
      <li class="post">
        <a href="http://ancienttime.blogbus.com/">你好旧时光</a>
      </li>
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><!-- GoStats JavaScript Based Code -->
<script type="text/javascript" src="http://gostats.cn/js/counter.js"></script>
<script type="text/javascript">_gos='c4.gostats.cn';_goa=383095;
  _got=7;_goi=3;_goz=0;_god='hits';_gol='网站计数器';_GoStatsRun();</script>
<noscript><a target="_blank" title="网站计数器" 
    href="http://gostats.cn"><img alt="网站计数器" 
    src="http://c4.gostats.cn/bin/count/a_383095/t_7/i_3/z_0/show_hits/counter.png" 
    style="border-width:0" /></a></noscript>
<!-- End GoStats JavaScript Based Code -->
<p>
  Copyright &copy; 2016 - Liu Yutao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <span class="credit"> and <a href="http://gitcafe.com/signup?invited_by=mctrain" target="_blank">GitCafe</a></span>
</p>
  

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mctrainsblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ytliu.github.io/blog/2015/07/30/xende-qi-dong-zhi-nei-cun-xiang-guan-shi-xian/';
        var disqus_url = 'http://ytliu.github.io/blog/2015/07/30/xende-qi-dong-zhi-nei-cun-xiang-guan-shi-xian/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>







</body>
</html>
